<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Rdiffweb-commits] r65 - in trunk: rdiffWeb tests tests/deleted_dir	tests/deleted_dir/2006-01-04T01:49:50Z	tests/deleted_dir/2006-01-04T01:49:50Z/testdir2	tests/deleted_dir/2006-01-05T01:49:50Z	tests/deleted_dir/2006-01-05T01:49:50Z/testdir2	tests/deleted_dir/results tests/simple	tests/simple/2006-01-03T01:49:50Z tests/simple/2006-01-04T01:49:50Z	tests/simple/2006-01-05T01:49:50Z tests/simple/results
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/rdiffweb-commits/2006-October/index.html" >
   <LINK REL="made" HREF="mailto:rdiffweb-commits%40lists.berlios.de?Subject=Re%3A%20%5BRdiffweb-commits%5D%20r65%20-%20in%20trunk%3A%20rdiffWeb%20tests%20tests/deleted_dir%0A%09tests/deleted_dir/2006-01-04T01%3A49%3A50Z%0A%09tests/deleted_dir/2006-01-04T01%3A49%3A50Z/testdir2%0A%09tests/deleted_dir/2006-01-05T01%3A49%3A50Z%0A%09tests/deleted_dir/2006-01-05T01%3A49%3A50Z/testdir2%0A%09tests/deleted_dir/results%20tests/simple%0A%09tests/simple/2006-01-03T01%3A49%3A50Z%20tests/simple/2006-01-04T01%3A49%3A50Z%0A%09tests/simple/2006-01-05T01%3A49%3A50Z%20tests/simple/results&In-Reply-To=%3C200610090237.k992bauE000038%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000023.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Rdiffweb-commits] r65 - in trunk: rdiffWeb tests tests/deleted_dir	tests/deleted_dir/2006-01-04T01:49:50Z	tests/deleted_dir/2006-01-04T01:49:50Z/testdir2	tests/deleted_dir/2006-01-05T01:49:50Z	tests/deleted_dir/2006-01-05T01:49:50Z/testdir2	tests/deleted_dir/results tests/simple	tests/simple/2006-01-03T01:49:50Z tests/simple/2006-01-04T01:49:50Z	tests/simple/2006-01-05T01:49:50Z tests/simple/results</H1>
    <B>commits at rdiffweb.org</B> 
    <A HREF="mailto:rdiffweb-commits%40lists.berlios.de?Subject=Re%3A%20%5BRdiffweb-commits%5D%20r65%20-%20in%20trunk%3A%20rdiffWeb%20tests%20tests/deleted_dir%0A%09tests/deleted_dir/2006-01-04T01%3A49%3A50Z%0A%09tests/deleted_dir/2006-01-04T01%3A49%3A50Z/testdir2%0A%09tests/deleted_dir/2006-01-05T01%3A49%3A50Z%0A%09tests/deleted_dir/2006-01-05T01%3A49%3A50Z/testdir2%0A%09tests/deleted_dir/results%20tests/simple%0A%09tests/simple/2006-01-03T01%3A49%3A50Z%20tests/simple/2006-01-04T01%3A49%3A50Z%0A%09tests/simple/2006-01-05T01%3A49%3A50Z%20tests/simple/results&In-Reply-To=%3C200610090237.k992bauE000038%40sheep.berlios.de%3E"
       TITLE="[Rdiffweb-commits] r65 - in trunk: rdiffWeb tests tests/deleted_dir	tests/deleted_dir/2006-01-04T01:49:50Z	tests/deleted_dir/2006-01-04T01:49:50Z/testdir2	tests/deleted_dir/2006-01-05T01:49:50Z	tests/deleted_dir/2006-01-05T01:49:50Z/testdir2	tests/deleted_dir/results tests/simple	tests/simple/2006-01-03T01:49:50Z tests/simple/2006-01-04T01:49:50Z	tests/simple/2006-01-05T01:49:50Z tests/simple/results">commits at rdiffweb.org
       </A><BR>
    <I>Mon Oct  9 04:37:36 CEST 2006</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000023.html">[Rdiffweb-commits] r66 - in trunk: rdiffWeb tests	tests/deleted_dir/results tests/deleted_file	tests/deleted_file/2006-01-03T01:49:50Z	tests/deleted_file/2006-01-04T01:49:50Z tests/deleted_file/results
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22">[ date ]</a>
              <a href="thread.html#22">[ thread ]</a>
              <a href="subject.html#22">[ subject ]</a>
              <a href="author.html#22">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: joshn
Date: 2006-10-09 04:36:29 +0200 (Mon, 09 Oct 2006)
New Revision: 65

Added:
   trunk/tests/deleted_dir/
   trunk/tests/deleted_dir/2006-01-03T01:49:50Z/
   trunk/tests/deleted_dir/2006-01-04T01:49:50Z/
   trunk/tests/deleted_dir/2006-01-04T01:49:50Z/testdir2/
   trunk/tests/deleted_dir/2006-01-04T01:49:50Z/testdir2/testfile6
   trunk/tests/deleted_dir/2006-01-04T01:49:50Z/testdir2/testfile7
   trunk/tests/deleted_dir/2006-01-05T01:49:50Z/
   trunk/tests/deleted_dir/2006-01-05T01:49:50Z/testdir2/
   trunk/tests/deleted_dir/2006-01-05T01:49:50Z/testdir2/testfile8
   trunk/tests/deleted_dir/2006-01-05T01:49:50Z/testdir2/testfile9
   trunk/tests/deleted_dir/results/
   trunk/tests/deleted_dir/results/dir_entries.txt
   trunk/tests/simple/
   trunk/tests/simple/2006-01-03T01:49:50Z/
   trunk/tests/simple/2006-01-03T01:49:50Z/file.txt
   trunk/tests/simple/2006-01-04T01:49:50Z/
   trunk/tests/simple/2006-01-04T01:49:50Z/file.txt
   trunk/tests/simple/2006-01-05T01:49:50Z/
   trunk/tests/simple/2006-01-05T01:49:50Z/file.txt
   trunk/tests/simple/results/
   trunk/tests/simple/results/dir_entries.txt
Removed:
   trunk/tests/basic/
Modified:
   trunk/rdiffWeb/librdiff.py
Log:
Fix bugs in dir listings (thanks to Jan Hugo Prins for reporting these).


Modified: trunk/rdiffWeb/librdiff.py
===================================================================
--- trunk/rdiffWeb/librdiff.py	2006-09-21 02:28:09 UTC (rev 64)
+++ trunk/rdiffWeb/librdiff.py	2006-10-09 02:36:29 UTC (rev 65)
@@ -159,13 +159,17 @@
          if entry.shouldShowIncrement() or entry.isMissingIncrement():
             entryDate = entry.getDate()
             if not entry.isSnapshotIncrement():
-               entryDate = self._getFirstBackupAfterDate(entry.getDate())
-            if (not entryName in entriesDict.keys()):
+               if entry.isMissingIncrement():
+                  entryDate = self._getFirstBackupAfterDate(entry.getDate())
+               else:
+                  entryDate = entry.getDate()
+            if not entryName in entriesDict.keys():
                entryPath = joinPaths(self.repo, rdiffIncrementsDirName, self.dirPath, entryName)
                newEntry = dirEntry(entryName, os.path.isdir(entryPath), 0, False, [entryDate])
                entriesDict[entryName] = newEntry
             else:
-               bisect.insort_left(entriesDict[entryName].changeDates, entryDate)
+               if not entryDate in entriesDict[entryName].changeDates:
+                  bisect.insort_left(entriesDict[entryName].changeDates, entryDate)
 
       return entriesDict
 
@@ -178,7 +182,7 @@
    def _getLastChangedBackupTime(self, filename):
       files = self.groupedIncrementEntries.get(filename, [])
       if os.path.isdir(joinPaths(self.completePath, filename)):
-         files = filter(lambda x: x.endswith(&quot;.dir&quot;), files)
+         files = filter(lambda x: x.endswith(&quot;.dir&quot;) or x.endswith(&quot;.missing&quot;), files)
       files.sort()
       if not files:
          return self._getFirstBackupAfterDate(None)
@@ -415,18 +419,11 @@
       return filter(lambda x: not x.startswith(&quot;.&quot;), os.listdir(self.masterDirPath))
 
    def getBackupStates(self, backupTestDir):
-      return filter(lambda x: not x.startswith(&quot;.&quot;), os.listdir(backupTestDir))
+      return filter(lambda x: not x.startswith(&quot;.&quot;) and x != &quot;results&quot;, os.listdir(backupTestDir))
+   
+   def getExpectedDirEntriesResults(self, testName):
+      return open(joinPaths(self.masterDirPath, testName, &quot;results&quot;, &quot;dir_entries.txt&quot;)).read()
 
-   def fileChangedBetweenBackups(self, backupTest, filename, lastBackup, allBackups):
-      prevRevisions = filter(lambda x: x &lt; lastBackup, allBackups)
-      if not prevRevisions: return False
-      oldVersion = prevRevisions[-1]
-      oldFilePath = joinPaths(self.masterDirPath, backupTest, oldVersion, filename)
-      newFilePath = joinPaths(self.masterDirPath, backupTest, lastBackup, filename)
-
-      if not os.access(oldFilePath, os.F_OK): return False
-      return open(oldFilePath, &quot;r&quot;).read() == open(newFilePath, &quot;r&quot;).read()
-
    ################  Start actual tests ###################
    def testGetDirEntries(self):
       tests = self.getBackupTests()
@@ -435,37 +432,16 @@
          rdiffDestDir = joinPaths(self.destRoot, testDir)
          entries = getDirEntries(rdiffDestDir, &quot;/&quot;)
 
-         # Go back through all backup states and make sure that the backup entries match the files that exist
-         origStateDir = joinPaths(self.masterDirPath, testDir)
-         backupStates = self.getBackupStates(origStateDir)
-         backupStates.sort(lambda x, y: cmp(x, y))
-         for backupState in backupStates:
-            backupTime = rdw_helpers.rdwTime()
-            backupTime.initFromString(backupState)
+         statusText = &quot;&quot;
+         for entry in entries:
+            for changeDate in entry.changeDates:
+               statusText = statusText + entry.name + &quot;\t&quot; + str(entry.isDir) + &quot;\t&quot; + str(entry.fileSize) + &quot;\t&quot; + str(entry.exists) + &quot;\t&quot; + changeDate.getUrlString()+&quot;\n&quot;
+            
+         assert statusText.replace(&quot;\n&quot;, &quot;&quot;) == self.getExpectedDirEntriesResults(testDir).replace(&quot;\n&quot;, &quot;&quot;), &quot;Got: &quot; + statusText + &quot;\nExpected:&quot; + self.getExpectedDirEntriesResults(testDir)
 
-            # Go through each file, and make sure we have a backup entry for this file and date
-            origStateDir = joinPaths(self.masterDirPath, testDir, backupState)
-            files = self.getBackupStates(origStateDir)
-            for file in files:
-               origFilePath = joinPaths(origStateDir, file)
+   def testGetDirRestoreDates(self):
+      pass
 
-               entry = getMatchingDirEntry(entries, file)
-               assertionErrorMessage = &quot;backupTime &quot;+backupTime.getDisplayString()+&quot; not found in backup entries for backup test \&quot;&quot;+testDir+&quot;\&quot; for file \&quot;&quot;+file+&quot;\&quot;. Returned changeDates:&quot;
-               for changeDate in entry.changeDates:
-                  assertionErrorMessage = assertionErrorMessage + &quot;\n&quot;+changeDate.getDisplayString()
-               assertionErrorMessage = assertionErrorMessage + &quot;\nIncrements dir: &quot;+str(os.listdir(joinPaths(rdiffDestDir, &quot;rdiff-backup-data&quot;, &quot;increments&quot;)))
-               for entryDate in entry.changeDates:
-                  if backupTime.getSeconds() == entryDate.getSeconds():
-                     if self.fileChangedBetweenBackups(testDir, entry.name, backupState, backupStates):
-                        assert False, assertionErrorMessage
-                     break
-               else:
-                  if not self.fileChangedBetweenBackups(testDir, entry.name, backupState, backupStates):
-                     assert False or False, assertionErrorMessage
-               assert os.path.isdir(origFilePath) == entry.isDir
-               #assert os.lstat(origFilePath)[6] == entry.fileSize, &quot;Real size: &quot;+str(os.lstat(origFilePath)[6])+&quot; Reported size: &quot;+str(entry.fileSize)
-
-
    def testGetBackupHistory(self):
       tests = self.getBackupTests()
       for testDir in tests:
@@ -498,10 +474,6 @@
 
          # Test that timezone differences are ignored
          historyAsOf = lastEntry.date.getUrlString()
-#          if &quot;+&quot; in historyAsOf:
-#             historyAsOf = historyAsOf.replace(&quot;+&quot;, &quot;-&quot;)
-#          else:
-#             historyAsOf = historyAsOf[:19] + &quot;+&quot; + historyAsOf[20:]
 
          lastBackupTime = rdw_helpers.rdwTime()
          lastBackupTime.initFromString(historyAsOf)

Added: trunk/tests/deleted_dir/2006-01-04T01:49:50Z/testdir2/testfile6
===================================================================

Added: trunk/tests/deleted_dir/2006-01-04T01:49:50Z/testdir2/testfile7
===================================================================

Added: trunk/tests/deleted_dir/2006-01-05T01:49:50Z/testdir2/testfile8
===================================================================

Added: trunk/tests/deleted_dir/2006-01-05T01:49:50Z/testdir2/testfile9
===================================================================

Added: trunk/tests/deleted_dir/results/dir_entries.txt
===================================================================
--- trunk/tests/deleted_dir/results/dir_entries.txt	2006-09-21 02:28:09 UTC (rev 64)
+++ trunk/tests/deleted_dir/results/dir_entries.txt	2006-10-09 02:36:29 UTC (rev 65)
@@ -0,0 +1,3 @@
+testdir2	True	112	True	2006-01-04T01:49:50Z
+testdir2	True	112	True	2006-01-05T01:49:50Z
+

Added: trunk/tests/simple/2006-01-03T01:49:50Z/file.txt
===================================================================
--- trunk/tests/simple/2006-01-03T01:49:50Z/file.txt	2006-09-21 02:28:09 UTC (rev 64)
+++ trunk/tests/simple/2006-01-03T01:49:50Z/file.txt	2006-10-09 02:36:29 UTC (rev 65)
@@ -0,0 +1,3 @@
+This file is changed before the second backup.
+And changed again before the third backup.
+testdir1 has been removed before the third backup.

Added: trunk/tests/simple/2006-01-04T01:49:50Z/file.txt
===================================================================

Added: trunk/tests/simple/2006-01-05T01:49:50Z/file.txt
===================================================================

Added: trunk/tests/simple/results/dir_entries.txt
===================================================================
--- trunk/tests/simple/results/dir_entries.txt	2006-09-21 02:28:09 UTC (rev 64)
+++ trunk/tests/simple/results/dir_entries.txt	2006-10-09 02:36:29 UTC (rev 65)
@@ -0,0 +1,4 @@
+file.txt	False	0	True	2006-01-03T01:49:50Z
+file.txt	False	0	True	2006-01-04T01:49:50Z
+file.txt	False	0	True	2006-01-05T01:49:50Z
+


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000023.html">[Rdiffweb-commits] r66 - in trunk: rdiffWeb tests	tests/deleted_dir/results tests/deleted_file	tests/deleted_file/2006-01-03T01:49:50Z	tests/deleted_file/2006-01-04T01:49:50Z tests/deleted_file/results
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22">[ date ]</a>
              <a href="thread.html#22">[ thread ]</a>
              <a href="subject.html#22">[ subject ]</a>
              <a href="author.html#22">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/rdiffweb-commits">More information about the Rdiffweb-commits
mailing list</a><br>
</body></html>
